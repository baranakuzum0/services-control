- name: Enforce Service Health and show YAML safely
  hosts: all
  gather_facts: false
  vars:
    services:
      - rsyslog.service
      - zabbix-agent2.service

  tasks:

    - name: Ensure services are started and enabled (ignore errors)
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop: "{{ services }}"
      ignore_errors: yes

    - name: Gather systemctl show output for each service
      ansible.builtin.command:
        cmd: "systemctl show {{ item }} --no-pager"
      loop: "{{ services }}"
      ignore_errors: yes
      register: svc_detailed

    - name: Convert stdout_lines to dict per service
      set_fact:
        service_status_summary: "{{ service_status_summary|default({}) | combine({item.item: dict(item.stdout_lines | select('match', '.+=') | map('split', '=') | map('first') | zip(item.stdout_lines | select('match', '.+=') | map('split', '=') | map('last'))) }) }}"
      loop: "{{ svc_detailed.results }}"
      when: item.stdout_lines is defined

    - name: Add FAILED/OK flag
      set_fact:
        service_status_summary: >-
          {% set ns = namespace(new_dict={}) %}
          {% for key, value in service_status_summary.items() %}
          {%   set _ = ns.new_dict.update({key: value | combine({'Status': 'FAILED' if value.ActiveState != 'active' else 'OK'})}) %}
          {% endfor %}
          {{ ns.new_dict }}
      when: service_status_summary is defined

    - name: Show final service status
      ansible.builtin.debug:
        var: service_status_summary
      when: service_status_summary is defined
